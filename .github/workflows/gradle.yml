# This workflow ensures that all commits to main build, and
# then publishes those builds as an artifact for the EC2
# webserver to grab & deploy.

name: Gradle Build

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        
        steps:
        # Setup
        - name: Checkout up-to-date from origin
          uses: actions/checkout@v4
        - name: Setup Java Environment
          uses: actions/setup-java@v4
          with:
            distribution: "temurin"
            java-version: "17"
        - name: Setup Gradle
          uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0

        # Build
        - name: Build Gradle project
          run: ./gradlew build

        # Publish
        - name: Upload built .jars
          id: upload-artifact
          uses: actions/upload-artifact@v4
          with:
            name: Package
            path: build/libs
        - name: Report URL of newest build
          id: report-url
          run: echo ${{ steps.upload-artifact.outputs.artifact-url }}

        # SSH into EC2 server to deploy new version
        - name: Get Job ID from GH API
          id: get-job-id
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
            jobs=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id}}/attempts/${{ github.run_attempt }}/jobs)
            job_id=$(echo $jobs | jq -r '.jobs[] | select(.runner_name=="${{ runner.name }}") | .id')
            echo "job_id=$job_id" >> $GITHUB_OUTPUT
        - name: SSH into EC2 and deploy
          uses: appleboy/ssh-action@v1.2.2
          with:
            host: ${{ secrets.EC2_HOSTNAME }}
            username: ${{ secrets.EC2_USER }}
            key: ${{ secrets.EC2_SSH_KEY_PRIVATE }}
            port: 22
            script: |
              set -e
              cd "${{ secrets.EC2_SITE_DIR }}"
              echo ${{ steps.get-job-id.outputs.job_id }} > ${{ secrets.EC2_JOB_ID_PATH }}
              python3 ${{ secrets.EC2_DEPLOY_SCRIPT_PATH }}
