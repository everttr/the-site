# This workflow ensures that all commits to main build, and
# then publishes those builds as an artifact for the EC2
# webserver to grab & deploy.

name: Gradle Build

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        
        steps:
        # Setup
        - name: Checkout up-to-date from origin
          uses: actions/checkout@v4
        - name: Setup Java Environment
          uses: actions/setup-java@v4
          with:
            distribution: "temurin"
            java-version: "17"
        - name: Setup Gradle
          uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0

        # Build
        - name: Build Gradle project
          run: ./gradlew build

        # Publish
        - name: Upload built .jars
          id: upload-artifact
          uses: actions/upload-artifact@v4
          with:
            name: Package
            path: build/libs
        - name: Report URL of newest build
          id: report-url
          run: echo ${{ steps.upload-artifact.outputs.artifact-url }}

        # Get current job URL for later
        - name: Get Job ID from GH API
          uses: Tiryoh/gha-jobid-action@v0
          id: get-job-id
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            job_name: ${{ github.job }}

        # SSH into EC2 server to deploy new version
        - name: SSH into EC2 and deploy
          uses: appleboy/ssh-action@master
          with:
            host: ${{ secrets.EC2_HOSTNAME }}
            username: ${{ secrets.EC2_USER }}
            key: ${{ secrets.EC2_SSH_KEY_PRIVATE }}
            script: |
              set -e
              cd "${{ secrets.EC2_SITE_DIR }}"
              echo ${{ steps.get-job-id.outputs.url }} > ${{ secrets.EC2_JOB_URL_PATH }}
              python3 ${{ secrets.EC2_DEPLOY_SCRIPT_PATH }}
